import TelegramBot from "node-telegram-bot-api";
import dotenv from "dotenv";

dotenv.config();

const BOT_TOKEN = process.env.BOT_TOKEN;
const WEBAPP_URL = process.env.WEBAPP_URL;

// –ë–∞–∑–æ–≤–∏–π URL –±–µ–∫–µ–Ω–¥—É (–±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫—ñ–Ω—Ü—ñ)
const API_BASE =
  (WEBAPP_URL ? WEBAPP_URL.replace(/\/+$/, "") : "") ||
  "https://food-miniapp.onrender.com";

if (!BOT_TOKEN) {
  console.error("‚ùå BOT_TOKEN –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π —É .env");
  process.exit(1);
}

console.log("Starting bot...");
console.log("API_BASE:", API_BASE);

const bot = new TelegramBot(BOT_TOKEN, { polling: true });

console.log("Bot is now running and polling updates...");

// ===================== /start =====================
bot.on("message", async (msg) => {
  // –©–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É web_app_data
  if (msg.web_app_data) return;

  console.log("MESSAGE RECEIVED:", msg);

  if (msg.text === "/start") {
    await bot.sendMessage(
      msg.chat.id,
      "–ü—Ä–∏–≤—ñ—Ç! –¶–µ Coconut AI ü••\n–ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º—ñ–Ω—ñ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫.",
      {
        reply_markup: {
          keyboard: [
            [
              {
                text: "–í—ñ–¥–∫—Ä–∏—Ç–∏ Coconut AI",
                web_app: { url: WEBAPP_URL },
              },
            ],
          ],
          resize_keyboard: true,
        },
      }
    );
  }
});

// ===================== WEB APP DATA =====================
bot.on("web_app_data", async (msg) => {
  try {
    console.log("WEBAPP DATA RAW:", msg.web_app_data);
    const chatId = msg.chat.id;

    let payload = {};
    try {
      payload = JSON.parse(msg.web_app_data.data || "{}");
    } catch (e) {
      console.error("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ web_app_data:", e);
    }

    const action = payload.open || payload.action || null;
    console.log("WEBAPP ACTION:", action, "PAYLOAD:", payload);

    if (action === "recipe") {
      await handleRecipe(chatId);
    } else if (action === "chat") {
      await bot.sendMessage(
        chatId,
        "–ù–∞–ø–∏—à–∏ –º–µ–Ω—ñ –≤ —á–∞—Ç, —â–æ —Ç–∏ —Ö–æ—á–µ—à –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏, —ñ —è –¥–æ–ø–æ–º–æ–∂—É –∑ —ñ–¥–µ—è–º–∏ ü§ñ"
      );
    } else if (action === "photo") {
      await bot.sendMessage(
        chatId,
        "–ù–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ —Ñ–æ—Ç–æ —Å—Ç—Ä–∞–≤–∏, —ñ —è —Å–ø—Ä–æ–±—É—é —ó—ó –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ üì∑"
      );
    } else {
      await bot.sendMessage(
        chatId,
        "–û—Ç—Ä–∏–º–∞–≤ –¥–∞–Ω—ñ –≤—ñ–¥ Mini App üôå (–¥—ñ—è –ø–æ–∫–∏ —â–æ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞)"
      );
    }
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ –æ–±—Ä–æ–±–Ω–∏–∫—É web_app_data:", err);
  }
});

// ===================== –õ–û–ì–Ü–ö–ê –†–ï–¶–ï–ü–¢–£ =====================

async function handleRecipe(chatId) {
  try {
    // 1) –¢—è–≥–Ω–µ–º–æ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç—ñ–≤
    const listRes = await fetch(`${API_BASE}/api/recipes`);
    if (!listRes.ok) {
      console.error("‚ùå /api/recipes —Å—Ç–∞—Ç—É—Å:", listRes.status);
      await bot.sendMessage(
        chatId,
        "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç—ñ–≤ –∑ —Å–µ—Ä–≤–µ—Ä–∞ üòî"
      );
      return;
    }

    const list = await listRes.json();

    if (!Array.isArray(list) || list.length === 0) {
      await bot.sendMessage(chatId, "–ü–æ–∫–∏ —â–æ –≤ –±–∞–∑—ñ –Ω–µ–º–∞—î —Ä–µ—Ü–µ–ø—Ç—ñ–≤ üòî");
      return;
    }

    // 2) –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —Ä–µ—Ü–µ–ø—Ç
    const random = list[Math.floor(Math.random() * list.length)];
    const recipeId = random.id ?? 0;

    // 3) –¢—è–≥–Ω–µ–º–æ –¥–µ—Ç–∞–ª—ñ —Ä–µ—Ü–µ–ø—Ç—É
    const detailRes = await fetch(`${API_BASE}/api/recipes/${recipeId}`);
    if (!detailRes.ok) {
      console.error("‚ùå /api/recipes/:id —Å—Ç–∞—Ç—É—Å:", detailRes.status);
      await bot.sendMessage(
        chatId,
        "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ —Ä–µ—Ü–µ–ø—Ç—É üòî"
      );
      return;
    }

    const detail = await detailRes.json();

    // 4) –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç
    let text = `üçΩ ${detail.title || "–†–µ—Ü–µ–ø—Ç"}\n\n`;

    if (Array.isArray(detail.ingredients) && detail.ingredients.length > 0) {
      text += "–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:\n";
      text += detail.ingredients.map((i) => `‚Ä¢ ${i}`).join("\n");
      text += "\n\n";
    }

    if (detail.description) {
      text += detail.description;
    }

    // 5) –Ø–∫—â–æ —î –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î–º–æ —Ñ–æ—Ç–æ, —ñ–Ω–∞–∫—à–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
    if (detail.image) {
      const fullImageUrl = detail.image.startsWith("http")
        ? detail.image
        : `${API_BASE}${detail.image}`;

      try {
        await bot.sendPhoto(chatId, fullImageUrl, {
          caption: text,
        });
      } catch (e) {
        console.error("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–æ—Ç–æ:", e);
        await bot.sendMessage(chatId, text);
      }
    } else {
      await bot.sendMessage(chatId, text);
    }
  } catch (e) {
    console.error("‚ùå handleRecipe error:", e);
    await bot.sendMessage(
      chatId,
      "–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Ä–µ—Ü–µ–ø—Ç—É. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ —Ç—Ä–æ—à–∫–∏ –ø—ñ–∑–Ω—ñ—à–µ üôè"
   }
}
